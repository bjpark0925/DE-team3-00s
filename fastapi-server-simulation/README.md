# 택시 배차 및 주행 시뮬레이션 시스템

## 개요

이 시뮬레이션 시스템은 두 가지 주요 구성 요소로 이루어져 있습니다:

1.  **시뮬레이션 클라이언트**: 대규모 택시의 움직임을 실시간으로 시뮬레이션하는 Python 스크립트입니다.
2.  **배차 API 서버**: 시뮬레이션된 택시에게 지능적인 배차 경로를 추천하는 FastAPI 기반의 웹 서버입니다.

이 시스템의 목표는 택시들을 승객 수요가 많은 지역으로 전략적으로 유도하는 동시에 택시 간의 경쟁을 최소화하여 전반적인 운영 효율성과 승객 탑승률을 높이는 것입니다.

---

## 구성 요소

### 1. 시뮬레이션 클라이언트 (`simulation_request_place_and_ride_str.py`)

이 스크립트는 시뮬레이션 엔진 역할을 하며, 다수의 택시의 행동을 동시에 모델링합니다.

**주요 기능:**

* **대규모 택시 시뮬레이션**: 멀티스레딩을 사용하여 지정된 수(예: 1000대)의 택시를 동시에 시뮬레이션하며, 각 택시는 독립적으로 행동합니다.
* **시간 가속**: 시뮬레이션은 가속된 속도(기본 설정 값은 10배속)로 실행되어, 6분 만에 1시간 동안의 활동을 모델링할 수 있습니다.
* **데이터 기반 행동 모델**: 시뮬레이션은 과거의 실제 주행 데이터셋(`manhattan_rides_2024_03_01_18_to_19.csv`)을 기반으로 합니다. 택시들은 이 데이터에 기록된 실제 승객의 탑승 요청과 매칭을 시도합니다.
* **핵심 로직**: 각 택시는 다음의 순환 로직을 따릅니다:
    1.  **승객 탐색**: 현재 위치한 존(zone)에서, 몇 분(시뮬레이션 시간 기준) 내에 발생할 예정인 과거 데이터상의 승객 탑승 요청을 탐색합니다.
    2.  **승객 탑승 (매칭 성공)**: 승객을 찾으면, `/request_ride` 엔드포인트를 호출하여 서버에 탑승 사실을 알리고 승객의 목적지 존으로 "이동"을 시뮬레이션합니다.
    3.  **배차 요청 (매칭 실패)**: 주변에 이용 가능한 승객이 없으면, `/simulation/request_place` 엔드포인트를 호출하여 서버에 새로운 목적지를 요청합니다. 서버는 이동할 최적의 존을 응답으로 보내줍니다.
* **결과물**: 시뮬레이션은 각 택시의 행동(탑승, 배차, 하차)에 대한 실시간 상태 로그를 출력합니다. 완료 시, 시뮬레이션된 택시들이 성공적으로 운행한 모든 과거 주행 기록이 담긴 `matched_rides.csv` 파일을 저장합니다.

### 2. 배차 API 서버 (`test_sim_place_str.py`)

이 서버는 시뮬레이션의 지능적인 부분을 담당합니다. FastAPI로 구축된 견고한 백엔드로서 실시간 데이터를 관리하고 최적의 배차 위치를 계산합니다.

**아키텍처:**

* **웹 프레임워크**: 효율적이고 비동기적인 API 엔드포인트를 만들기 위해 FastAPI를 사용합니다.
* **데이터베이스 (정적 데이터)**: AWS RDS (PostgreSQL) 인스턴스는 미리 계산된 비교적 정적인 데이터를 저장합니다. 예:
    * 시간대별, 존별 예상 승객 탑승 수.
    * 각 존에 인접한 다른 존들의 목록.
* **데이터베이스 (동적 데이터)**: AWS DynamoDB는 택시들의 동적인 상태를 추적하기 위한 고성능 실시간 데이터베이스로 사용됩니다. 다음과 같은 중요 정보를 저장합니다:
    * 특정 존으로 향하고 있는 택시의 현재 대수.
    * 각 개별 택시에 마지막으로 할당된 목적지.
    * 총 배차 및 탑승 이벤트에 대한 실시간 카운터.
    * 
### 3. 서버 시작 시 데이터 자동 생성 및 오류 알림

API 서버는 안정적인 운영을 위해 지능적인 시작 프로세스를 갖추고 있습니다. 서버가 시작될 때, 배차 추천 로직에 필수적인 데이터(시간대별 예상 탑승 수, 인접 존 목록)가 AWS RDS 데이터베이스에 존재하는지 먼저 확인합니다.

만약 이 데이터가 존재하지 않을 경우, 데이터 처리 작업이 아직 수행되지 않은 것으로 간주하고 자동화된 복구 및 알림 절차를 실행합니다.

데이터 처리 자동 트리거: 서버는 os.system을 통해 AWS CLI 명령어를 실행하여, 데이터 처리를 담당하는 EC2 Spark 인스턴스를 자동으로 시작시킵니다. 만약 두 번째 시도에서도 데이터 로드에 실패하면, 시스템에 심각한 오류(예: Spark 작업 실패 또는 RDS 연결 문제)가 발생한 것으로 판단합니다. 이때 서버는 지정된 Slack 채널으로 오류 알림 메시지를 보내 개발자에게 즉시 문제를 알리고, 불안정한 상태로 서비스가 시작되는 것을 방지하기 위해 예외(Exception)를 발생시켜 시작 프로세스를 안전하게 중단합니다.

이러한 메커니즘을 통해 데이터 파이프라인에 문제가 발생하더라도 이를 자동으로 복구하거나, 복구 실패 시 신속하게 상황을 인지하고 대응할 수 있습니다.

**API 엔드포인트 및 로직:**

* **`POST /simulation/request_place`**: 핵심적인 배차 추천 엔드포인트입니다.
    * 택시가 새로운 위치를 요청하면, 서버는 해당 택시의 현재 위치에 인접한 존 목록을 가져옵니다.
    * 각 인접 존에 대해 다음 공식을 기반으로 **배차 점수**를 계산합니다:
        $$\text{점수} = \frac{\text{예상 탑승객 수 (RDS 기반)}}{\text{해당 존으로 이미 이동 중인 택시 수 (DynamoDB 기반)} + 1}$$
    * 이 알고리즘은 과거 데이터상 수요가 높은 지역으로 택시를 보내는 것과, 한 지역에 너무 많은 택시가 몰리는 것을 방지하는 것 사이의 균형을 지능적으로 조절합니다.
    * 서버는 택시의 새로운 목적지를 DynamoDB에 업데이트하고, 가장 높은 점수를 받은 존을 택시에 반환합니다. 이 시스템은 다수의 택시로부터의 동시 요청을 데이터 손상 없이 처리하도록 설계되었습니다.

* **`POST /request_ride`**: 로깅 메커니즘 역할을 하는 엔드포인트입니다.
    * 시뮬레이션된 택시가 승객을 성공적으로 태웠을 때 이 엔드포인트를 호출합니다.
    * 서버는 해당 이벤트를 기록하고, DynamoDB에 있는 특정 존의 탑승 카운터를 증가시킵니다. 이를 통해 시뮬레이션 성능에 대한 실시간 분석이 가능해집니다.

---

## 시스템 워크플로우

1.  **시뮬레이션 클라이언트**가 시작되면 1000개의 택시 스레드가 초기화됩니다. 각 택시는 기본 시작 존에서 운행을 시작합니다. 시작 존 id는 164, Midtown South로 인접 zone이 가장 많은 곳입니다.
2.  승객이 없는 택시는 **배차 서버**의 `/simulation/request_place` API를 호출합니다.
3.  서버는 탑승 수요(RDS 기반)와 현재 택시 공급량(DynamoDB 기반)의 균형을 맞춰 최적의 인접 존을 계산하고 클라이언트에 반환합니다.
4.  서버는 DynamoDB의 실시간 상태를 즉시 업데이트하여, 해당 존으로 향하는 택시가 한 대 추가되었음을 기록합니다.
5.  시뮬레이션된 택시는 새로운 존으로 "이동"합니다. 도착 후, 과거 데이터에서 매칭되는 승객이 있는지 확인합니다.
6.  **매칭 성공 시**: 택시는 `/request_ride` 엔드포인트를 호출합니다. 서버는 DynamoDB에 탑승을 기록하고, 택시는 승객 운송을 시뮬레이션합니다. 운행 종료 후, 2단계부터 과정을 반복합니다.
7.  **매칭 실패 시**: 즉시 2단계부터 과정을 반복하여 새로운 배차 장소를 요청합니다.
